name: ðŸ”„ Retrain Model dari Feedback Pengguna

on:
  issues:
    types: [opened]

jobs:
  retrain:
    # Hanya jalankan jika issue berlabel 'feedback'
    if: contains(github.event.issue.labels.*.name, 'feedback')
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›Žï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      - name: ðŸ’¬ Ekstrak feedback dari issue body
        run: |
          echo '${{ github.event.issue.body }}' | sed 's/\\n/\n/g' > feedback.txt
          cat feedback.txt

      - name: ðŸ§¹ Parse & tambahkan ke dataset
        run: python parse_feedback.py

      - name: ðŸ§  Latih ulang model (dengan evaluasi & metrik)
        run: python train_model.py

      - name: ðŸ“¤ Commit dan push perubahan
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add datasetdana.csv sentiment_model.pkl metrics.json assets/
          git commit -m "chore: update dataset, model, dan metrik dari feedback (Issue #${{ github.event.issue.number }})"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Beri komentar sukses di issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "âœ… Terima kasih! Model telah dilatih ulang dengan feedback Anda. Perubahan sudah di-commit ke repo."
            })