name: ðŸ”„ Retrain Model dari Feedback Pengguna

on:
  issues:
    types: [opened]

jobs:
  retrain:
    # Hanya jalankan jika issue berlabel 'feedback'
    if: contains(github.event.issue.labels.*.name, 'feedback')
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›Žï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install -r requirements.txt

      - name: ðŸ’¬ Ekstrak feedback dari issue body
        run: |
          echo '${{ github.event.issue.body }}' | sed 's/\\n/\n/g' > feedback.txt
          cat feedback.txt

      - name: ðŸ§¹ Parse & tambahkan ke dataset
        run: python parse_feedback.py

      - name: ðŸ§  Latih ulang model
        run: |
          python -c "
          import pandas as pd
          from sklearn.feature_extraction.text import TfidfVectorizer
          from sklearn.svm import SVC
          from sklearn.pipeline import Pipeline
          import joblib
          import re
          from nltk.corpus import stopwords
          import nltk
          nltk.download('stopwords', quiet=True)
          ID_STOPWORDS = set(stopwords.words('indonesian'))

          def preprocess_text(text):
              if not isinstance(text, str): return ''
              text = text.lower()
              text = re.sub(r'[^a-z\s]', '', text)
              words = [w for w in text.split() if w not in ID_STOPWORDS and len(w) > 2]
              return ' '.join(words)

          df = pd.read_csv('datasetdana.csv')
          df = df.dropna(subset=['content', 'pelabelan 3 kelas'])
          df['clean_content'] = df['content'].apply(preprocess_text)
          X = df['clean_content']
          y = df['pelabelan 3 kelas'].str.lower().str.strip()

          model = Pipeline([
              ('tfidf', TfidfVectorizer(max_features=5000)),
              ('clf', SVC(kernel='linear', probability=True))
          ])
          model.fit(X, y)
          joblib.dump(model, 'sentiment_model.pkl')
          print('âœ… Model berhasil dilatih ulang.')
          "

      - name: ðŸ“¤ Commit dan push perubahan
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add datasetdana.csv sentiment_model.pkl
          git commit -m "chore: update dataset & model from user feedback (Issue #${{ github.event.issue.number }})"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Beri komentar sukses di issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "âœ… Terima kasih! Model telah dilatih ulang dengan feedback Anda. Perubahan sudah di-commit ke repo."
            })